<!doctype html>
<meta charset="utf-8" />
<title>Claim</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>html,body{height:100%}body{margin:0;display:grid;place-items:center;background:#0f172a;color:#fff;font:14px system-ui}</style>
<div>設定中…</div>
<script>
(async () => {
  // NFCタグURLは /claim.html#ip=...&cara=... を想定（? でもOK）
  const qs = location.hash.slice(1) || location.search.slice(1);
  const sp = new URLSearchParams(qs);
  const ip = sp.get('ip');
  const cara = sp.get('cara');

  // まずURLからパラメータを消す（漏洩防止）
  history.replaceState(null, '', '/');

  if (!ip || !cara) { location.replace('/'); return; }

  // SW登録 → プロファイルをSWへpostMessage
  if ('serviceWorker' in navigator) {
    await navigator.serviceWorker.register('/sw.js', { scope: '/' });
    const reg = await navigator.serviceWorker.ready;
    (reg.active || navigator.serviceWorker.controller)?.postMessage({ type: 'setProfile', ip, cara });

    // 反映確認（/api/bootstrap をSWが返せるか）→ ルートへ
    for (let i = 0; i < 10; i++) {
      try {
        const r = await fetch('/api/bootstrap', { cache: 'no-store' });
        if (r.ok) break;
      } catch {}
      await new Promise(r => setTimeout(r, 120));
    }
  }
  location.replace('/');
})();
</script>
